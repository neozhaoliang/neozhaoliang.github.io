<!DOCTYPE HTML>
<html>

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SHQJ7GP8MM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-SHQJ7GP8MM');
    </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

        <title>
            Make awesome gif animation in a few seconds with pure Python! | Why so serious?</title>
    <meta name="author" content="Zhao Liang">
    
    <meta name="description" content="This program can help you make gif animations of various algorithms
running on the 2d square grid.

Requirements: tqdm for showing process
bar and pil">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="Make awesome gif animation in a few seconds with pure Python!"/>
    <meta property="og:site_name" content="Why so serious?"/>

    
    <meta property="og:image" content=""/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Why so serious?" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/desert.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

    <body>
        <img src="/favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

        <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">Why so serious?</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/favicon.png" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">Zhao Liang</p>
                        <p class="desc">math &amp;&amp; programming</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/计数组合学/">
                    计数组合学 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/完美采样/">
                    完美采样 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/pywonderland-项目/">
                    pywonderland-项目 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Shadertoy/">
                    Shadertoy <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/有限群表示与结合代数/">
                    有限群表示与结合代数 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/线性代数/">
                    线性代数 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/可视化复分析/">
                    可视化复分析 <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Williams-概率和鞅/">
                    Williams-概率和鞅 <span class="right">3 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


            <main>
                <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            

        

        
    </div>
</nav>

    <article>
        <div class="card">
            <div class="card-content">
                

                            <div class="article-title">
                                
    
        <h1>Make awesome gif animation in a few seconds with pure Python!</h1>
    


                            </div>
                            <time class="pink-link-context" datetime="2015-11-20T16:00:00.000Z"><a href="/gifmaze/index.html">2015-11-21</a></time>

                                

                                    <div class="toc pink-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#examples"><span class="section table-of-contents-text">Examples</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#whats-special-about-this-program"><span class="section table-of-contents-text">What’s special about this
program</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#how-did-this-program-come-out"><span class="section table-of-contents-text">How did this program come
out</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#what-is-wilsons-algorithm"><span class="section table-of-contents-text">What is Wilson’s algorithm</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#implementation"><span class="section table-of-contents-text">Implementation</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#a-short-introduction-to-the-gif89a-specification"><span class="section table-of-contents-text">A short
introduction to the GIF89a specification</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#the-header-gif89a"><span class="section table-of-contents-text">The header GIF89a</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#the-logical-screen-descriptor"><span class="section table-of-contents-text">The logical screen
descriptor</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#global-color-table"><span class="section table-of-contents-text">Global color table</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#graphics-control-block"><span class="section table-of-contents-text">Graphics control block</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#image-descriptor-block"><span class="section table-of-contents-text">Image descriptor block</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#the-lzw-compression-algorithm"><span class="section table-of-contents-text">The LZW compression
algorithm</span></a></li></ol></li></ol>
</div>
                                        
                                            <div class="entry pink-link-context">
                                                
<p>This program can help you make gif animations of various algorithms
running on the 2d square grid.</p>
<blockquote>
<p><strong>Requirements</strong>: <code>tqdm</code> for showing process
bar and <code>pillow</code> for reading images.</p>
</blockquote>
<h1 id="examples">Examples</h1>
<ul>
<li><p>Wilson’s uniform spanning tree algorithm (my favourite, 2349
frames, 333KB, generated in 3 seconds):</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/wilson-bfs.gif"></p></li>
<li><p>Prim’s algorithm:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/prim.gif"></p></li>
<li><p>Kruskal’s algorithm:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/kruskal.gif"></p></li>
<li><p>Langton’s ant:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/langton-ant.gif"></p></li>
<li><p>Hilbert curve：</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/hilbert.gif"></p></li>
<li><p>Conway’s game of life (gosper glider gun):</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/gosperglidergun.gif"></p></li>
</ul>
<h1 id="whats-special-about-this-program">What’s special about this
program</h1>
<p>The code is implemented in pure Python, no third-party modules nor
softwares are required, just built-in modules like <code>struct</code>,
<code>random</code>, <code>colorsys</code> and some built-in functions,
and without any “color” or “draw” function calls. In later versions I
added some features like showing process bars (requires
<code>tqdm</code>) and enabling the user to embed the animtion into a
background image (requires <code>pillow</code>). The program runs much
faster than expected, it can generate highly optimized gif output in
only a few seconds. One drawback is that it’s not quite user-friendly:
the user must have some basic knowledge of the GIF89a specification to
know how to set parameters correctly in the animation.</p>
<h1 id="how-did-this-program-come-out">How did this program come
out</h1>
<p>This program is motivated by Mike Bostock’s wonderful <a target="_blank" rel="noopener" href="https://bl.ocks.org/mbostock/11357811">Javascript animation</a>. A
few years ago when I saw Mike’s page I immediately had the idea of
writing a Python version to produce gif animations of Wilson’s
algorithm. A first thought on this was to save the animation into frames
and then pack them back into a whole gif. But the animation usually
contains thousands of frames so this is definitely a horrible task and
is far from being efficient. Luckily five years later I learnt the
GIF89a specification by chance and suddenly realized the new approach of
encoding the animation into a byte stream. So basically I implemented a
small gif encoder first, then run the algorithm on a 2d grid (use a 2d
array to represent it) and encode it into frames along the way.</p>
<h1 id="what-is-wilsons-algorithm">What is Wilson’s algorithm</h1>
<p>Consider the following problem:</p>
<blockquote>
<p><strong>Problem</strong>: Let <span class="math inline">\(G\)</span>
be a finite, connected and undirected graph. How can one choose a random
spanning tree among all spanning trees of <span class="math inline">\(G\)</span> from uniform probability? (we shall
call such a tree an uniform spanning tree, or simply an
<strong>UST</strong>.)</p>
</blockquote>
<p>The following image shows an UST of a 48x36 grid, the circled dot is
the root vertex:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/ust.png"></p>
<p>You might say “that’s easy, just write a program that lists all
spanning trees and then use a random integer to choose one”. But let’s
consider the complete graph <span class="math inline">\(K_n\)</span> for
example: <span class="math inline">\(K_n\)</span> has <span class="math inline">\(n^{n/2}\)</span> many different spanning trees by
<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cayley%27s_formula">Cayley’s
formula</a>, for <span class="math inline">\(n=100\)</span> this number
is <span class="math inline">\(100^{98}\)</span>, far more larger than
the number of particles in the universe! (which is estimated about <span class="math inline">\(10^{90}\)</span>)</p>
<p>Currently the most efficient algorithm known is the one proposed in
Wilson’s paper</p>
<blockquote>
<p>“generating random spanning trees more quickly than the cover
time”.</p>
</blockquote>
<p>It’s a random algorithm, that is, some times you may be very lucky to
get an UST soon, or you may wait forever. But one can prove that this
algorithm will terminate in finite steps with probability one (note this
does not exclude the possibility of running forever, think about this),
and it performs really well in most cases.</p>
<p>The key to understand Wilson’s algorithm is the so called <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Loop-erased_random_walk">loop erased
random walk</a>, that is, once the random walk visits a vertex that
already existed in its path, it immediately erases the loop between
these two visits and continues the walk from this vertex. Just watch the
Javascript animation if you don’t understand this, it’s obvious to see
what “loop erased random walk” means from it. (click on the canvas to
restart the animation)</p>
<script type="text/javascript" src="/images/code/wilson.js"></script>
<div data-align="center">
<canvas id="wilson" width="600" height="600">
</canvas>
</div>
<p>The algorithm runs as follows:</p>
<blockquote>
<p><strong>Wilson’s algorithm</strong>:</p>
<ol type="1">
<li>Choose any vertex <span class="math inline">\(v\)</span> as the root
and maintain a tree <span class="math inline">\(T\)</span>, initially
<span class="math inline">\(T=\{v\}\)</span>.</li>
<li>For any vertex <span class="math inline">\(z\)</span> that is not in
<span class="math inline">\(T\)</span>, start a loop erased random walk
from <span class="math inline">\(z\)</span> until the walk hits <span class="math inline">\(T\)</span>, then add the resulting path of the
walk to <span class="math inline">\(T\)</span>.</li>
<li>Repeat step 2 until all vertices of the graph are in <span class="math inline">\(T\)</span>.</li>
</ol>
</blockquote>
<p>The proof of the correctness of this algorithm is a bit tricky and
will not be discussed here, you may refer to Wilson’s original paper or
the book by Russell Lyons and Yuval Peres:</p>
<blockquote>
<p>“Probability on Trees and Networks”.</p>
</blockquote>
<h1 id="implementation">Implementation</h1>
<p>As mentioned before, the animation of Wilson’s algorithm (and also
Langton’s ant animation) usually contains thousands of frames in it, so
it’s quite surprising that this program takes only a few seconds to
produce a highly optimized image. The key points are:</p>
<ul>
<li><p>Only encode a minimum region at a time. We can maintain a
rectangular region to store which cells are changed between successive
frames, this enables us to encode only a small portion of the window
instead of the whole into a frame.</p></li>
<li><p>Use variable mimimum code length for the LZW compression. When
encoding a frame into bytearrays LZW compression allows the minimum code
length <span class="math inline">\(k\)</span> can be as small as the
color depth of this frame (and must satisfy <span class="math inline">\(2\leq k\leq12\)</span>), this is another benifit
since most frames only contain very few colors.</p></li>
<li><p>Write the frames to a temporary <code>BytesIO</code> file in
memory and flush it to disk in the end.</p></li>
</ul>
<p>The code is divided into three layers: at the top layer is the
<code>Maze</code> class on which we run various algoirthms. This layer
knows nothing about the gif image. At the bottom layer is the
<code>GIFSurface</code> class which holds the raw information like image
size, global color table, number of loops, background color index, etc.
It knows nothing about the <code>Maze</code>. At the middle layer is the
<code>Animation</code> class which controls how the <code>Maze</code> is
encoded and writes to the <code>GIFSurface</code>.</p>
<h1 id="a-short-introduction-to-the-gif89a-specification">A short
introduction to the GIF89a specification</h1>
<p>In this section I’ll give a not-so-detailed introduction to the
GIF89a specification. It’s not meant to be comprehensive nor
self-contained, you should always refer to <a target="_blank" rel="noopener" href="http://giflib.sourceforge.net/whatsinagif/index.html">What’s in a
GIF</a> when you have difficulties understanding my words here.</p>
<p>Roughly a GIF image consists of:</p>
<blockquote>
<p><strong>Structure of a GIF File</strong></p>
<ol type="1">
<li>Always begins with 6 bytes <code>GIF89a</code>.</li>
<li>Then follows the <strong>logical screen descriptor</strong> which
specifies the width and height of the image and the size of the
<strong>global color table</strong>.</li>
<li>Then follows the global color table.</li>
<li>Then follows the <strong>loop control block</strong> which specifies
the number of loops of the image.</li>
<li>Then comes the actual data of the frames. The data of each frame can
be further divided into 3 parts:
<ol type="1">
<li>the <strong>graphics control block</strong> which specifies the
delay and transparent color of this frame.</li>
<li>the <strong>image descriptor</strong> which specifies the relative
position of this frame in the window and the size of the local color
table.</li>
<li>the local color table of this frame (if there is a local color table
for this frame).</li>
<li>the LZW compressed pixel data of this frame.</li>
</ol></li>
<li>Finally the image file ends with a byte <code>0x3B</code>.</li>
</ol>
</blockquote>
<div class="statement note definition unnumbered">
<p><span class="statement-heading"><span class="statement-label">注</span>：</span><span class="statement-spah">
</span>The above description does not apply to all GIF images, there can
be some variations. For example:</p>
<ol type="1">
<li><p>The image may not contain a global color table (so you have to
specify a local color table for each frame).</p></li>
<li><p>For a static image the loop control block is not required; for a
stacit frame the graphcs control block is not required.</p></li>
<li><p>The file may end without the byte <code>0x3B</code>, most
decoders can still decode the image correctly.</p></li>
</ol>
</div>
<p>Now we explain each part in more details.</p>
<h2 id="the-header-gif89a">The header GIF89a</h2>
<p>In python you can write it as</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">struct.pack(<span class="hljs-string">'6s'</span>, <span class="hljs-string">b'GIF89a'</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>Why <code>b'GIF89a'</code> not simply <code>'GIF89a'</code>? This is
for compatibility with Python2 and 3 since the default encoding in
Python3 is unicode whereas in python2 it’s ascii.</p>
<h2 id="the-logical-screen-descriptor">The logical screen
descriptor</h2>
<p>Example:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">struct.pack(<span class="hljs-string">'&lt;2H3B'</span>, width, height, <span class="hljs-number">0b10010001</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>Here you shoud note the format string <code>&lt;</code> (little
endian).</p>
<p>The byte <code>0b10010001</code> is called a packed field. Let’s read
it from left to right:</p>
<ol type="1">
<li>The first bit 1 means we have a global color table (0 for
absent).</li>
<li>The next 3 bits specify the “color depth”. You don’t need care about
what they mean since modern decoders like firefox and chrome do not use
them.</li>
<li>The fifth bit is the “sort flag” and is not used today, always set
to 0.</li>
<li>The ending 3 bits represent an integer <span class="math inline">\(x\)</span> in range 0-7, <span class="math inline">\(x\)</span> specifies the size of the global color
table (<span class="math inline">\(=2^{x+1})\)</span>.</li>
</ol>
<p>The last two bytes are of little importance and we don’t discuss them
here.</p>
<h2 id="global-color-table">Global color table</h2>
<p><strong>Example</strong>: if we want to use 4 colors red, green,
blue, yellow, then the global color table can be written as</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">bytearray</span>([<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>])<br></code></pre></td></tr></tbody></table></figure>
<p>It’s important that the number of colors in this array must be a
power of 2 and match the size of the global color table specified in the
packed byte in the logical screen descriptor, otherwise the decoder will
not be able to parse the image correctly.</p>
<h2 id="graphics-control-block">Graphics control block</h2>
<p><strong>Example</strong>:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">struct.pack(<span class="hljs-string">"&lt;4BH2B"</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0xF9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0b00000101</span>, delay, trans_index, <span class="hljs-number">0</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>The 3 beginning bytes <code>0x21, 0xF9, 4</code> are fixed and are
used to inform the decoder “Hey, I’m a graphics control block, see the
next 4 bytes!”</p>
<p>The next byte <code>0b00000101</code> is also a packed field, let’s
read it from left to right:</p>
<ol type="1">
<li>The first 3 bits are useless and are always 0.</li>
<li>The next 3 bits are called “desposal method”, they represent an
integer <span class="math inline">\(x\)</span> in range 0-7 and <span class="math inline">\(x\)</span> specifies how we should dispose this
frame after it’s displayed.
<ol type="1">
<li><p><span class="math inline">\(x=0\)</span> means it’s undefined,
decoders will use default 1 instead in this case.</p></li>
<li><p><span class="math inline">\(x=1\)</span> is the default, it means
leave this frame here. So if the next frame is not overlapped with this
frame then both these two frames will be displayed. Otherwise the
overlapped area in this frame will be covered by the next one. See the
example below:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/disposal1.gif"></p></li>
<li><p><span class="math inline">\(x=2\)</span> means remove this frame
and restore the image to background image/color, see the following
example:</p>
<p><img style="margin:0px auto;display:block" src="/images/gifmaze/disposal2.gif"></p>
<p>You can see each frame is remove immediately after it’s displayed,
and its region is filled with transparent background (so you are really
seeing the browser’s background color through the image).</p></li>
<li><p><span class="math inline">\(x=3\)</span> also means remove this
frame, but restore the image to the previous frame.
<img style="margin:0px auto;display:block" src="/images/gifmaze/disposal3.gif"></p></li>
<li><p>4-7 are unused.</p></li>
</ol></li>
</ol>
<p>The next 2 bytes <code>delay</code> specifies the delay of the frame
in centiseconds, so <code>delay=3</code> means “keep staying here for
0.03 second”.</p>
<p>The last byte <code>trans_index</code> specifies the transparent
color in this frame, the pixels in this frame using this color are
transparent: you can see the previous frame through them (of course only
when the previous frame is still there (reserved), otherwise you are
seeing the previous previous frame, …, etc).</p>
<h2 id="image-descriptor-block">Image descriptor block</h2>
<p>Example:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">struct.pack(<span class="hljs-string">'&lt;B4HB'</span>, <span class="hljs-number">0x2C</span>, left, top, width, height, <span class="hljs-number">0</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>Quite straight-forward to understand. Note the last byte is 0 since
we do not need local color tables here.</p>
<h2 id="the-lzw-compression-algorithm">The LZW compression
algorithm</h2>
<p>Finally we are left with the most difficult part: the LZW algorithm.
It’s too long to include an introduction to the algorithm here, so
please refer to <a target="_blank" rel="noopener" href="http://www.matthewflickinger.com/lab/whatsinagif/lzw_image_data.asp">the
second article in What’s in a gif</a> for a complete treatment. But it’s
quite simple to implement it in Python, see the file <a target="_blank" rel="noopener" href="https://github.com/neozhaoliang/pywonderland/blob/master/src/gifmaze/gifmaze/encoder.py">encoder.py</a>
for an example.</p>



                                                    

    
                                            </div>

            </div>
        </div>
    </article>

    


    <section id="comment">
       <script src="https://giscus.app/client.js"
        data-repo="neozhaoliang/neozhaoliang.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNDQ4MTYxMDc="
        data-category="Announcements"
        data-category-id="DIC_kwDOCKG3684CPDuy"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
       </script>
    </section>


</div>

                    <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

            </main>
            


                <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword pink lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>






	<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
  		tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
  		tex: 'ams'
		});
	</script>


	

			<script type="text/javascript"
				src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-svg.min.js?config=TeX-AMS_HTML"></script>

			
				

    </body>

    </html>